<cdk-virtual-scroll-viewport
  #tbl
  [ngClass]="viewportClass"
  [tvsItemSize]="rowHeight || 48"
  [headerHeight]="headerHeight || 56"
  [footerHeight]="headerHeight || 56"
  [headerEnabled]="headerEnable || true"
  [footerEnabled]="footerEnable || false"
  [ngStyle]="{'background-color': backgroundColor || 'white'}" 
  [class.printpreview]="printing"
  (requestRendering)="doRendering($event)">

  <mat-table
    matSort 
    class="table"
    multiTemplateDataRows
    [cdkDropListDisabled]="false"    
    cdkDropList 
    cdkDropListOrientation="horizontal"    
    (cdkDragStarted)="dragStarted($event)"
    (cdkDropListDropped)="dropListDropped($event)"    
    [@tableAnimation]
    [trackBy]="indexTrackFn"
    [dataSource]="dataSource">
    <!-- Checkbox Column -->
    <ng-container matColumnDef="row-checkbox">
      <mat-header-cell *matHeaderCellDef class="row-checkbox" style="z-index: 2;">
        <mat-checkbox style="z-index: 10;"
          (change)="$event ? masterToggle() : null"
          [checked]="rowSelectionModel.hasValue() && isAllSelected()"
          [indeterminate]="rowSelectionModel.hasValue() && !isAllSelected()"         
          *ngIf="rowSelectionMode === 'multi'">
        </mat-checkbox>
        <mat-icon *ngIf="rowSelectionMode === 'single'">indeterminate_check_box</mat-icon>
      </mat-header-cell>
      <mat-cell *matCellDef="let row" class="row-checkbox">
        <mat-checkbox
          (click)="$event.stopPropagation()"
          (change)="onRowSelectionChange($event, row)"
          [checked]="rowSelectionModel?.isSelected(row)">
        </mat-checkbox>
      </mat-cell>
    </ng-container> 
  
    <!-- Table Columns -->
    <ng-container *ngFor="let column of columns; let i = index; trackBy: trackColumn" [matColumnDef]="column.name"
      [sticky]="column.sticky === 'start' ? true : false" [stickyEnd]="column.sticky === 'end' ? true : false">      
      <!-- ************************** Table Header ************************* -->
      <mat-header-cell *matHeaderCellDef                
        cdkDrag 
        [cdkDragDisabled]="column?.draggable === false"
        cdkDragBoundary="mat-header-row"
        cdkDropListLockAxis="x"        
        [cdkDragData]="{name: column.name, columIndex: i}"        
        [style.maxWidth.px]="column.width"
        [style.minWidth.px]="column.width"        
        [class.active-resize]="resizeColumn.currentResizeIndex===i" cdkDragBoundary="mat-header-row">
        <div class="left-resizer-handler" (mousedown)="onResizeColumn($event, i, 'left')"></div>
        <header-filter [field]="column" (filterChanged)="filter_onChanged(column, $event)" [filters]="dataSource.getFilter(column.name)">
          <mat-icon class="column-icon" [ngStyle]="{ 'color': column?.iconColor }">{{column?.icon}}</mat-icon>          
          <mat-icon *ngIf="column?.draggable != false" class="drag-indicator" cdkDragHandle>drag_indicator</mat-icon>
          <div mat-sort-header [disabled]="column.sortable === false" class="header-caption">{{ column.header }}</div>
        </header-filter>
        <div
          class="right-resizer-handler"
          (mousedown)="onResizeColumn($event, i, 'right')"
        ></div>
      </mat-header-cell>
      <!-- ************************** Select Row ************************* -->
      <!-- <ng-container  *ngIf="column.name == '">
        <mat-cell *matCellDef="let row" class="row-checkbox">
          <mat-checkbox
            (click)="$event.stopPropagation()"
            (change)="onRowSelectionChange($event, row)"
            [checked]="rowSelectionModel?.isSelected(row)">
          </mat-checkbox>
        </mat-cell>
      </ng-container>       -->
      <!-- ************************** Table Cell ************************* -->
      <ng-container *ngIf="!column.dynamicCellComponent">
        <mat-cell *matCellDef="let row;" 
                  [matTooltip]="row[column.name]"
                  [style.maxWidth.px]="column.width"
                  [style.minWidth.px]="column.width"
                  [class]="row[column.cellClass]"
                  (click)="onCellClick($event, row, column)"                  
                  [ngClass]="cellClass(row?.option, column)"
                  [ngStyle]="cellStyle(row?.option, column)"
                  (contextmenu)="onContextMenu($event, column, row)">
          <mat-icon>{{cellIcon(row?.option, column?.name)}}</mat-icon>
          {{row[column.name]}}
        </mat-cell> 
      </ng-container>

      <!-- ************************** Dynamic Cell Component ************************* -->
      <ng-container *ngIf="column.dynamicCellComponent">
        <mat-cell *matCellDef="let row;"
                  [style.maxWidth.px]="column.width"
                  [style.minWidth.px]="column.width"
                  [class]="row[column.cellClass]"
                  (click)="onCellClick($event, row, column)"                  
                  [ngClass]="cellClass(row?.option, column)"
                  [ngStyle]="cellStyle(row?.option, column)"
                  (contextmenu)="onContextMenu($event, column, row)">          
          <ng-container dynamicCell [component]="column.dynamicCellComponent" [column]="column" [row]="row" [onRowEvent]="onRowEvent">
          </ng-container> 
        </mat-cell>
      </ng-container>
      
    </ng-container> 

    <ng-container matColumnDef="progress" > 
      <mat-header-cell
        *matHeaderCellDef
        [attr.colspan]="displayedColumns.length">
        <mat-progress-bar mode="indeterminate" [class.show]="pending">
        </mat-progress-bar>
      </mat-header-cell>
    </ng-container>

    <!-- Expanded Content Column - The detail row is made up of Dynamic Cell -->
    <ng-container *ngIf="expandColumn.length > 0" matColumnDef="expandedDetail">
      <td mat-cell *matCellDef="let row" [attr.colspan]="displayedColumns.length" class="expanded-detail-cell">
        <div class="expanded-detail" [@detailExpand]="row == expandedElement ? 'expanded' : 'collapsed'">
          <ng-container dynamicCell [component]="expandComponent" [row]="row" [onRowEvent]="onRowEvent">
          </ng-container> 
        </div>
      </td>
    </ng-container>
    <!-- Table Menu[ Sort, Visible, Export] -->
    <ng-container matColumnDef="table-menu" [stickyEnd]="true" *ngIf="setting?.visibleTableMenu !== false">
      <mat-header-cell *matHeaderCellDef class="table-menu">
        <table-menu
          [tableSetting]="tableSetting"
          (menuActionChange)="tableMenuActionChange($event)"
        ></table-menu> 
      </mat-header-cell>
      <mat-cell *matCellDef="let row" class="table-menu">
        <row-menu *ngIf="rowContextMenuItems && rowContextMenuItems.length > 0" [rowActionMenu]="row?.actionMenu" [actionMenus]="rowContextMenuItems" [tableSetting]="tableSetting" (rowActionChange)="rowActionChange($event, row)"></row-menu>
      </mat-cell>
    </ng-container>
    <!-- Row Table[Header, Data, Footer] -->    
    <mat-row 
      *matRowDef="let row; columns: displayedColumns;"
      (dblclick)="onRowDblClick($event, row)"
      (click)="onRowClick($event, row)"
      [style.height.px]="rowHeight"
      class="table-row"
      [ngClass]="row?.option?.class"
      [ngStyle]="rowStyle(row)"      
      [class.expanded-row]="expandedElement === row"
      [class.row-selection]="rowSelectionModel ? rowSelectionModel.isSelected(row) : false"
      (contextmenu)="onContextMenu($event, null, row)">
    </mat-row>
    <ng-container *ngIf="expandColumn.length > 0">      
      <tr mat-row *matRowDef="let expandRow; columns: expandColumn" class="detail-row"></tr>
    </ng-container>
    <mat-header-row class="header" *matHeaderRowDef="displayedColumns; sticky: sticky" [style.top.px]="inverseOfTranslation"></mat-header-row >
    <mat-header-row class="progress" *matHeaderRowDef="progressColumn; sticky: sticky" [style.top.px]="inverseOfTranslation + headerHeight - 5" ></mat-header-row>
  </mat-table> 
</cdk-virtual-scroll-viewport>
<mat-paginator
  *ngIf="pagingMode !== 'none'"
  class="table-paginator"
  [length]="pagination?.length"
  [pageSize]="pagination?.pageSize"
  [pageIndex]="pagination?.pageIndex"
  (page)="pagination_onChange($event)"
  [pageSizeOptions]="pagination?.pageSizeOptions">
</mat-paginator>
<ng-content></ng-content>
 
<div class="no-records" *ngIf="showNoData === true && (!dataSource || dataSource.data.length === 0)">
  <!-- <mat-icon>web</mat-icon>  -->
  {{ languagePack?.tableLabels.NoData }}  
  <br>
  <button *ngIf="showReload" mat-icon-button color="primary" (click)="reload_onClick()"><mat-icon>autorenew</mat-icon></button>
</div>

<!-- Context Menu -->
<div style="visibility: hidden; position: fixed"  
  [style.left]="contextMenuPosition.x"
  [style.top]="contextMenuPosition.y"
  [matMenuTriggerFor]="contextMenu">
</div>
<mat-menu #contextMenu="matMenu">
	<ng-template matMenuContent let-item="item">		
    <ng-container *ngFor="let menu of contextMenuItems">
      <button mat-button [class.ltr-menu]="tableSetting.direction === 'rtl'" [color]="menu.color" class="button-menu" 
        [disabled]="menu.disabled" (click)="onContextMenuItemClick(menu)">
         <mat-icon>{{menu.icon}}</mat-icon>
        <span [class.text-align-right]="tableSetting.direction === 'rtl'" class="text-align-left">{{menu.text}}</span>
      </button>
      <mat-divider *ngIf="menu.divider === true"></mat-divider>
    </ng-container>    
	</ng-template>
</mat-menu>